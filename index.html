<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoreZ</title>
    <style>
        :root {
            --primary: #d4af37; --bg: #0f1014; --card-bg: #1b1e26;
            --text: #ffffff; --danger: #ff4d4d; --sale: #ff0000; --success: #00c851;
            --chat-user: #005f99; --chat-admin: #333;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; user-select: none; }

        /* Ticker */
        .ticker-wrap { width: 100%; background: #000; overflow: hidden; height: 30px; border-bottom: 1px solid #333; }
        .ticker { display: inline-block; white-space: nowrap; animation: ticker 30s linear infinite; line-height: 30px;}
        .ticker-item { display: inline-block; padding: 0 2rem; color: #888; font-size: 0.85rem; }
        .ticker-item b { color: var(--primary); }
        @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* Nav */
        nav { display: flex; justify-content: center; align-items: center; padding: 20px; background: #161920; border-bottom: 2px solid #333; position: relative; }
        .logo { font-size: 2rem; color: var(--primary); font-weight: bold; text-transform: uppercase; letter-spacing: 2px; cursor: pointer; }
        
        /* The hidden login container */
        #secretLogin { position: absolute; top: 20px; right: 20px; display: none; z-index: 999; }
        .admin-btn { background: var(--primary); border: 1px solid var(--primary); color: #000; padding: 5px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; }

        .container { padding: 20px; max-width: 1000px; margin: 0 auto; }

        /* Admin UI */
        #adminArea { display: none; border-left: 2px solid var(--primary); padding-left: 15px; margin-bottom: 30px;}
        .admin-section { background: var(--card-bg); padding: 20px; border-radius: 10px; border: 1px solid #444; margin-bottom: 20px; }
        .admin-header { color: var(--primary); margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; }
        
        .form-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 200px; margin-bottom: 10px; }
        label { display: block; color: #aaa; font-size: 0.85rem; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; background: #0f1014; border: 1px solid #444; color: white; border-radius: 5px; box-sizing: border-box; }
        
        .btn { padding: 10px; width: 100%; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 5px; color: black; }
        .btn-save { background: var(--primary); }
        .btn-del { background: var(--danger); color: white; width: auto; padding: 2px 8px; }
        .btn-io { background-color: #2196F3; color: white; margin-bottom: 10px; }
        .file-input { display: none; }

        /* Store Grid */
        .cat-tabs { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .cat-tab { background: #1b1e26; border: 1px solid #444; color: #aaa; padding: 8px 20px; border-radius: 20px; cursor: pointer; }
        .cat-tab.active { background: var(--primary); color: #000; font-weight: bold; }

        .store-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .card { background: var(--card-bg); border-radius: 10px; overflow: hidden; border: 1px solid #333; display: flex; flex-direction: column; transition: transform 0.2s; position: relative; }
        .card:hover { transform: translateY(-5px); border-color: #555; }
        
        .card-img-top { width: 100%; height: 180px; object-fit: cover; }
        .card-body { padding: 15px; text-align: center; flex-grow: 1; display: flex; flex-direction: column; }
        .card-title { margin: 0 0 5px 0; color: #fff; font-size: 1.1rem; }
        
        .price-container { margin-bottom: 10px; min-height: 25px; }
        .current-price { color: var(--primary); font-weight: bold; font-size: 1.2rem; }
        .old-price { text-decoration: line-through; color: #666; font-size: 0.9rem; margin-right: 5px; }
        .sale-badge { position: absolute; top: 10px; right: 10px; background: var(--sale); color: white; padding: 3px 8px; border-radius: 3px; font-weight: bold; font-size: 0.8rem; z-index: 10; }

        .buy-btn { margin-top: auto; display: block; width: 100%; padding: 10px 0; background: linear-gradient(45deg, #005f99, #0088cc); color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }

        /* MODAL & CHAT STYLES */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background: var(--card-bg); padding: 25px; border-radius: 10px; border: 1px solid var(--primary); width: 90%; max-width: 400px; text-align: center; }
        .chat-box { width: 100%; height: 300px; background: #000; border: 1px solid #333; margin-top: 10px; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .message { padding: 8px 12px; border-radius: 15px; font-size: 0.9rem; max-width: 80%; word-wrap: break-word; }
        .msg-system { align-self: center; background: #333; color: #aaa; font-size: 0.8rem; }
        .msg-user { align-self: flex-end; background: var(--chat-user); color: white; border-bottom-right-radius: 2px; }
        .msg-admin { align-self: flex-start; background: var(--chat-admin); color: #ddd; border-bottom-left-radius: 2px; border: 1px solid #555; }
        .chat-input-area { display: flex; gap: 5px; margin-top: 10px; }
        
        /* Admin Chat List */
        .admin-chat-item { background: #111; padding: 10px; margin-bottom: 5px; border: 1px solid #333; cursor: pointer; display: flex; justify-content: space-between; align-items: center;}
        .admin-chat-item:hover { background: #222; }
        .admin-chat-item.active { border-color: var(--primary); }
        .badge { background: red; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; }

        .list-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #333; font-size: 0.9rem; align-items: center;}
    </style>
</head>
<body>

    <div class="ticker-wrap"><div class="ticker" id="buyerTicker"></div></div>

    <nav>
        <!-- Click logo 5 times to reveal admin if hash fails -->
        <div class="logo" onclick="clickLogo()">StoreZ</div>
        
        <!-- Secret Login Button Container -->
        <div id="secretLogin">
            <button class="admin-btn" id="authBtn" onclick="handleAuth()">Admin Login</button>
        </div>
    </nav>

    <div class="container">
        
        <!-- ADMIN PANEL -->
        <div id="adminArea">
            <h2 style="color:var(--primary);">Admin Dashboard</h2>
            
            <!-- LIVE CHATS -->
            <div class="admin-section">
                <h4 class="admin-header">Live Orders & Chats</h4>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px;">
                        <label>Active Conversations</label>
                        <div id="adminChatList" style="height: 300px; overflow-y: auto; border: 1px solid #333; background: #000;"></div>
                    </div>
                    <div style="flex: 2; min-width: 300px; display: none;" id="adminChatWindow">
                        <label id="adminChatTitle">Chatting with...</label>
                        <div id="adminMessages" class="chat-box"></div>
                        <div class="chat-input-area">
                            <input type="text" id="adminMsgInput" placeholder="Type to customer...">
                            <button class="btn btn-save" style="width: auto;" onclick="sendAdminMessage()">Send</button>
                        </div>
                        <button class="btn btn-del" style="margin-top: 10px;" onclick="closeCurrentChat()">Close & Delete Order</button>
                    </div>
                </div>
            </div>

            <!-- PRODUCT MANAGER -->
            <div class="admin-section">
                <h4 class="admin-header">Add / Edit Item</h4>
                <input type="hidden" id="editItemId">
                <div class="form-row">
                    <div class="form-group"><label>Name</label><input type="text" id="itemName"></div>
                    <div class="form-group"><label>Category</label><select id="itemCatSelect"></select></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Original Price</label><input type="number" id="itemPrice"></div>
                    <div class="form-group"><label>Sale Price (Optional)</label><input type="number" id="itemSale"></div>
                </div>
                <div class="form-group"><label>Image URL</label><input type="text" id="itemImg"></div>
                
                <button class="btn btn-save" onclick="saveItem()">Save Item</button>
                <button class="btn" style="background:#444; color:white;" onclick="clearForm()">Clear</button>
            </div>

            <div class="admin-section">
                <h4 class="admin-header">Data Backup</h4>
                <button class="btn btn-io" onclick="exportFromFirebase()">â¬‡ Backup Data</button>
                <button class="btn btn-io" onclick="document.getElementById('jsonInput').click()">â¬† Restore Data</button>
                <input type="file" id="jsonInput" class="file-input" accept=".json" onchange="importToFirebase(this)">
                
                <h4 class="admin-header" style="margin-top:20px;">Categories</h4>
                <div class="form-row">
                    <input type="text" id="catName" placeholder="New Category Name">
                    <button class="btn btn-save" style="width:auto;" onclick="addCategory()">Add</button>
                </div>
                <div id="catList" style="margin-top:10px;"></div>
            </div>
        </div>

        <!-- PUBLIC STORE -->
        <div class="cat-tabs" id="catTabs"></div>
        <div class="store-grid" id="storeGrid"></div>
    </div>

    <!-- CUSTOMER ORDER MODAL -->
    <div id="orderModal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color:var(--primary)" id="modalItemName">Buying Item</h3>
            <p>Please enter your MLBB ID to proceed.</p>
            <input type="text" id="customerMlbbId" placeholder="User ID (e.g. 12345678)" style="text-align:center; font-size: 1.1rem; width: 100%; box-sizing:border-box;">
            <button class="btn btn-save" style="margin-top:15px;" onclick="submitOrder()">Start Order</button>
            <button class="btn" style="background:transparent; color:#888;" onclick="closeModal('orderModal')">Cancel</button>
        </div>
    </div>

    <!-- CUSTOMER CHAT MODAL -->
    <div id="customerChatModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 500px;">
            <h3 style="color:var(--primary)">Private Conversation</h3>
            <div id="customerMessages" class="chat-box"></div>
            <div class="chat-input-area" id="customerInputArea">
                <input type="text" id="customerMsgInput" placeholder="Message to Admin...">
                <button class="btn btn-save" style="width: auto;" onclick="sendCustomerMessage()">Send</button>
            </div>
            <p style="font-size:0.8rem; color:#666; margin-top:5px;">Do not refresh the page or you will lose the chat.</p>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, onSnapshot, doc, deleteDoc, updateDoc, setDoc, query, orderBy, where, writeBatch, arrayUnion, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // ------------------------------------------------------------------
        // PASTE YOUR CONFIG HERE
        const firebaseConfig = {
          apiKey: "AIzaSyDY5pFsMKK3o-_GzDdrhoqvKJiMGYQFdzo",
          authDomain: "storez-68603.firebaseapp.com",
          projectId: "storez-68603",
          storageBucket: "storez-68603.firebasestorage.app",
          messagingSenderId: "555550726462",
          appId: "1:555550726462:web:98cfd4a27cfdb04209346f"
        };
        // ------------------------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // State
        let itemsData = [];
        let categoriesData = [];
        let currentCat = "All";
        let isAdmin = false;
        let logoClicks = 0;

        // Chat State
        let currentItemBuying = null;
        let activeCustomerChatId = null;
        let activeAdminChatId = null;
        let chatUnsubscribe = null;

        // --- SECRET ROUTE CHECK ---
        function checkSecretRoute() {
            const isSecret = window.location.hash.includes('nimda');
            const loginDiv = document.getElementById("secretLogin");
            if(isSecret) loginDiv.style.display = "block";
        }
        window.checkSecretRoute = checkSecretRoute; // Expose to global
        window.setInterval(checkSecretRoute, 1000); // Check every second to be sure

        // Backup: Click logo 5 times to show login
        window.clickLogo = () => {
            logoClicks++;
            if(logoClicks >= 5) {
                document.getElementById("secretLogin").style.display = "block";
                alert("Admin Button Revealed");
            }
        };

        // --- AUTH ---
        window.handleAuth = () => {
            if (auth.currentUser) {
                signOut(auth).then(() => window.location.reload());
            } else {
                const email = prompt("Admin Email:");
                const pass = prompt("Password:");
                if(email && pass) signInWithEmailAndPassword(auth, email, pass).catch(e => alert(e.message));
            }
        };

        onAuthStateChanged(auth, (user) => {
            const btn = document.getElementById("authBtn");
            const panel = document.getElementById("adminArea");
            isAdmin = !!user;
            if (user) {
                btn.innerText = "Logout";
                panel.style.display = "block";
                initAdminChatListener();
            } else {
                btn.innerText = "Admin Login";
                panel.style.display = "none";
            }
            renderStore();
        });

        // --- DATA SYNC ---
        // Load Ticker (Who Bought)
        const qTicker = query(collection(db, "chats"), orderBy("timestamp", "desc"), limit(10));
        onSnapshot(qTicker, (snapshot) => {
            let html = "";
            if(snapshot.empty) {
                 html = `<div class="ticker-item">Welcome to StoreZ!</div>`;
            } else {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if(data.mlbbId && data.itemName) {
                        // Mask the ID (e.g. 123456 -> 123***)
                        let maskedId = data.mlbbId.length > 4 ? data.mlbbId.substring(0, 3) + "***" : "User";
                        html += `<div class="ticker-item">ðŸŽ‰ ID: <b>${maskedId}</b> bought <b>${data.itemName}</b></div>`;
                    }
                });
                // Duplicate content for smooth scrolling
                if(snapshot.size < 5) html += html + html; 
            }
            document.getElementById("buyerTicker").innerHTML = html;
        });

        const qCat = query(collection(db, "categories"), orderBy("order", "asc"));
        onSnapshot(qCat, (snapshot) => {
            categoriesData = [];
            snapshot.forEach((doc) => categoriesData.push({ id: doc.id, ...doc.data() }));
            renderCategories();
            renderCatList();
        });

        const qItems = query(collection(db, "items"), orderBy("order", "asc"));
        onSnapshot(qItems, (snapshot) => {
            itemsData = [];
            snapshot.forEach((doc) => itemsData.push({ id: doc.id, ...doc.data() }));
            renderStore();
        });

        // --- CUSTOMER ORDER & CHAT FLOW ---
        
        window.openBuyModal = (itemJson) => {
            const item = JSON.parse(decodeURIComponent(itemJson));
            currentItemBuying = item;
            document.getElementById("modalItemName").innerText = "Buying: " + item.name;
            document.getElementById("customerMlbbId").value = "";
            document.getElementById("orderModal").style.display = "flex";
        };

        window.closeModal = (id) => {
            document.getElementById(id).style.display = "none";
        };

        window.submitOrder = async () => {
            const mlbbId = document.getElementById("customerMlbbId").value.trim();
            if(!mlbbId) return alert("Please enter MLBB ID");

            const btn = document.querySelector("#orderModal .btn-save");
            btn.innerText = "Processing...";
            btn.disabled = true;

            try {
                // Determine price to save
                let finalPrice = currentItemBuying.salePrice ? currentItemBuying.salePrice : currentItemBuying.price;

                // Create Chat Session
                const chatRef = await addDoc(collection(db, "chats"), {
                    mlbbId: mlbbId,
                    itemName: currentItemBuying.name,
                    itemPrice: finalPrice,
                    status: 'open',
                    timestamp: Date.now(),
                    messages: [{
                        sender: 'system',
                        text: `Order started for ${currentItemBuying.name} @ â‚±${finalPrice}. ID: ${mlbbId}. Please wait for admin.`,
                        time: Date.now()
                    }]
                });

                activeCustomerChatId = chatRef.id;
                closeModal("orderModal");
                document.getElementById("customerChatModal").style.display = "flex";
                
                // Listen to chat
                onSnapshot(doc(db, "chats", activeCustomerChatId), (docSnap) => {
                    if(docSnap.exists()) {
                        const data = docSnap.data();
                        renderMessages(data.messages, "customerMessages");
                    } else {
                        alert("Chat ended by admin.");
                        window.location.reload();
                    }
                });

            } catch (error) {
                console.error("Error creating order:", error);
                alert("Error starting order: " + error.message);
            } finally {
                btn.innerText = "Start Order";
                btn.disabled = false;
            }
        };

        window.sendCustomerMessage = async () => {
            const input = document.getElementById("customerMsgInput");
            const text = input.value.trim();
            if(!text || !activeCustomerChatId) return;

            const msg = { sender: 'user', text: text, time: Date.now() };
            try {
                await updateDoc(doc(db, "chats", activeCustomerChatId), { messages: arrayUnion(msg) });
                input.value = "";
            } catch(e) { console.error(e); alert("Message failed. Check internet."); }
        };

        function renderMessages(msgs, divId) {
            const container = document.getElementById(divId);
            container.innerHTML = "";
            msgs.forEach(m => {
                let cls = "msg-system";
                if(m.sender === 'user') cls = "msg-user";
                if(m.sender === 'admin') cls = "msg-admin";
                container.innerHTML += `<div class="message ${cls}">${m.text}</div>`;
            });
            container.scrollTop = container.scrollHeight;
        }

        // --- ADMIN CHAT FLOW ---

        function initAdminChatListener() {
            const q = query(collection(db, "chats"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById("adminChatList");
                list.innerHTML = "";
                snapshot.forEach(d => {
                    const chat = d.data();
                    const isActive = activeAdminChatId === d.id ? "active" : "";
                    list.innerHTML += `
                        <div class="admin-chat-item ${isActive}" onclick="openAdminChat('${d.id}')">
                            <div>
                                <strong>${chat.mlbbId}</strong><br>
                                <span style="font-size:0.8rem; color:#aaa;">${chat.itemName} (â‚±${chat.itemPrice})</span>
                            </div>
                            <div class="badge">Open</div>
                        </div>`;
                });
            });
        }

        window.openAdminChat = (chatId) => {
            activeAdminChatId = chatId;
            document.getElementById("adminChatWindow").style.display = "flex";
            if(chatUnsubscribe) chatUnsubscribe();
            chatUnsubscribe = onSnapshot(doc(db, "chats", chatId), (docSnap) => {
                if(docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById("adminChatTitle").innerText = `Chat: ${data.mlbbId} (${data.itemName})`;
                    renderMessages(data.messages, "adminMessages");
                } else {
                    document.getElementById("adminChatWindow").style.display = "none";
                }
            });
        };

        window.sendAdminMessage = async () => {
            const input = document.getElementById("adminMsgInput");
            const text = input.value.trim();
            if(!text || !activeAdminChatId) return;
            const msg = { sender: 'admin', text: text, time: Date.now() };
            await updateDoc(doc(db, "chats", activeAdminChatId), { messages: arrayUnion(msg) });
            input.value = "";
        };

        window.closeCurrentChat = async () => {
            if(!activeAdminChatId) return;
            if(confirm("Close order and delete chat history?")) {
                await deleteDoc(doc(db, "chats", activeAdminChatId));
                document.getElementById("adminChatWindow").style.display = "none";
                activeAdminChatId = null;
            }
        };

        // --- STORE & CATEGORY LOGIC ---
        window.addCategory = async () => {
            const name = document.getElementById("catName").value;
            if(name) {
                const order = categoriesData.length > 0 ? categoriesData[categoriesData.length-1].order + 1 : 1;
                await addDoc(collection(db, "categories"), { name, order });
                document.getElementById("catName").value = "";
            }
        };

        window.deleteCategory = async (id) => { if(confirm("Delete category?")) await deleteDoc(doc(db, "categories", id)); };

        function renderCategories() {
            const container = document.getElementById("catTabs");
            const select = document.getElementById("itemCatSelect");
            let tabs = `<div class="cat-tab ${currentCat === 'All' ? 'active' : ''}" onclick="window.setCat('All')">All</div>`;
            let opts = `<option value="">Select...</option>`;
            categoriesData.forEach(c => {
                tabs += `<div class="cat-tab ${currentCat === c.id ? 'active' : ''}" onclick="window.setCat('${c.id}')">${c.name}</div>`;
                opts += `<option value="${c.id}">${c.name}</option>`;
            });
            container.innerHTML = tabs;
            select.innerHTML = opts;
        }

        window.setCat = (id) => { currentCat = id; renderStore(); };

        function renderCatList() {
            const list = document.getElementById("catList");
            list.innerHTML = "";
            categoriesData.forEach((c) => {
                list.innerHTML += `<div class="list-item"><span>${c.name}</span><button class="btn-del" onclick="deleteCategory('${c.id}')">X</button></div>`;
            });
        }

        window.saveItem = async () => {
            const id = document.getElementById("editItemId").value;
            const data = {
                name: document.getElementById("itemName").value,
                price: Number(document.getElementById("itemPrice").value),
                salePrice: Number(document.getElementById("itemSale").value) || null, // Capture Sale Price
                catId: document.getElementById("itemCatSelect").value,
                image: document.getElementById("itemImg").value
            };
            if(!data.name || !data.price || !data.catId) { alert("Missing info"); return; }
            if(id) await updateDoc(doc(db, "items", id), data);
            else {
                const order = itemsData.length > 0 ? Math.max(...itemsData.map(i=>i.order||0)) + 1 : 1;
                data.order = order;
                await addDoc(collection(db, "items"), data);
            }
            window.clearForm();
        };

        window.deleteItem = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, "items", id)); };
        
        window.editItem = (id) => {
            const item = itemsData.find(i => i.id === id);
            document.getElementById("editItemId").value = item.id;
            document.getElementById("itemName").value = item.name;
            document.getElementById("itemPrice").value = item.price;
            document.getElementById("itemSale").value = item.salePrice || "";
            document.getElementById("itemCatSelect").value = item.catId;
            document.getElementById("itemImg").value = item.image;
            document.getElementById("adminArea").scrollIntoView();
        };

        window.clearForm = () => {
            document.querySelectorAll("#adminArea input").forEach(i => i.value = "");
            document.getElementById("itemCatSelect").value = "";
        };

        window.renderStore = () => {
            const grid = document.getElementById("storeGrid");
            grid.innerHTML = "";
            let filtered = currentCat === "All" ? [...itemsData] : itemsData.filter(i => i.catId === currentCat);
            if(filtered.length === 0) grid.innerHTML = "<p style='color:#666; width:100%; text-align:center;'>No items found.</p>";
            filtered.forEach(item => {
                let adminHtml = "";
                if(isAdmin) adminHtml = `<div style="padding:5px; display:flex; gap:5px;"><button class="btn-io" style="margin:0; font-size:0.8rem" onclick="editItem('${item.id}')">Edit</button><button class="btn-del" onclick="deleteItem('${item.id}')">Del</button></div>`;
                const itemString = encodeURIComponent(JSON.stringify(item));
                
                // SALE PRICE LOGIC
                let priceHtml = `<div class="current-price">â‚±${item.price}</div>`;
                let badgeHtml = "";
                if(item.salePrice && item.salePrice < item.price) {
                     priceHtml = `
                        <span class="old-price">â‚±${item.price}</span>
                        <span class="current-price" style="color:var(--sale)">â‚±${item.salePrice}</span>
                     `;
                     badgeHtml = `<div class="sale-badge">SALE</div>`;
                }

                grid.innerHTML += `
                    <div class="card">
                        ${badgeHtml}
                        <img src="${item.image || 'https://placehold.co/200x150?text=No+Image'}" class="card-img-top">
                        <div class="card-body">
                            <h3 class="card-title">${item.name}</h3>
                            <div class="price-container">${priceHtml}</div>
                            <button onclick="openBuyModal('${itemString}')" class="buy-btn">Buy Now</button>
                            ${adminHtml}
                        </div>
                    </div>`;
            });
        };

        window.exportFromFirebase = async () => {
            const data = { items: itemsData, categories: categoriesData };
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = "StoreZ_Backup.json";
            a.click();
        };

        window.importToFirebase = async (input) => {
            const file = input.files[0];
            if(!file || !confirm("Import data?")) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const json = JSON.parse(e.target.result);
                const batch = writeBatch(db);
                if(json.categories) json.categories.forEach(cat => batch.set(doc(collection(db, "categories")), { name: cat.name, order: cat.order || 0 }));
                if(json.items) json.items.forEach(item => batch.set(doc(collection(db, "items")), { name: item.name, price: item.price, catId: item.catId, image: item.image || "", order: item.order || 0 }));
                await batch.commit();
                alert("Done!");
            };
            reader.readAsText(file);
        };
    </script>
</body>
</html>
