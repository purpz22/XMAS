<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoreZ</title>
    <style>
        :root {
            --primary: #d4af37; --bg: #0f1014; --card-bg: #1b1e26;
            --text: #ffffff; --danger: #ff4d4d; --sale: #ff0000; --success: #00c851;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; user-select: none; }

        /* Ticker */
        .ticker-wrap { width: 100%; background: #000; overflow: hidden; height: 30px; border-bottom: 1px solid #333; }
        .ticker { display: inline-block; white-space: nowrap; animation: ticker 20s linear infinite; line-height: 30px;}
        .ticker-item { display: inline-block; padding: 0 2rem; color: var(--primary); font-size: 0.9rem; }
        @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* Nav */
        nav { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: #161920; border-bottom: 2px solid #333; }
        .logo { font-size: 1.5rem; color: var(--primary); font-weight: bold; text-transform: uppercase; }
        .admin-btn { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 5px 15px; cursor: pointer; border-radius: 4px; }
        
        .container { padding: 20px; max-width: 1200px; margin: 0 auto; }

        /* Admin UI */
        #adminArea { display: none; }
        .admin-section { background: var(--card-bg); padding: 20px; border-radius: 10px; border: 1px solid #444; margin-bottom: 20px; }
        .admin-header { color: var(--primary); margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; }
        
        .form-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 200px; margin-bottom: 10px; }
        label { display: block; color: #aaa; font-size: 0.85rem; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; background: #0f1014; border: 1px solid #444; color: white; border-radius: 5px; box-sizing: border-box; }
        
        .btn { padding: 10px; width: 100%; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 5px; color: black; }
        .btn-save { background: var(--primary); }
        .btn-green { background: var(--success); color: white; }
        .btn-del { background: var(--danger); color: white; width: auto; padding: 2px 8px; }
        .btn-move { background: #444; color: white; width: auto; padding: 2px 8px; margin-right: 2px; }
        .btn-io { background-color: #2196F3; color: white; margin-bottom: 10px; }
        .file-input { display: none; }

        /* Controls & Sorting */
        .controls-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;}
        .cat-tabs { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .cat-tab { background: #1b1e26; border: 1px solid #444; color: #aaa; padding: 8px 16px; border-radius: 20px; cursor: pointer; white-space: nowrap; }
        .cat-tab.active { background: var(--primary); color: #000; font-weight: bold; }
        .sort-select { width: auto; padding: 8px; margin-bottom: 0; }

        /* Store Grid */
        .store-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .card { background: var(--card-bg); border-radius: 10px; overflow: hidden; border: 1px solid #333; position: relative; display: flex; flex-direction: column; transition: transform 0.2s; }
        
        /* Drag Styles */
        .card.draggable { cursor: grab; border: 1px dashed #666; }
        .card.dragging { opacity: 0.5; border: 2px dashed var(--primary); }
        .card:hover { transform: translateY(-5px); border-color: #555; }
        
        .card-img-top { width: 100%; height: 160px; object-fit: cover; pointer-events: none; }
        .card-body { padding: 15px; text-align: center; flex-grow: 1; display: flex; flex-direction: column; }
        .card-title { margin: 0 0 5px 0; color: #fff; font-size: 1.1rem; pointer-events: none; }
        .price-container { margin-bottom: 15px; pointer-events: none; }
        .current-price { color: var(--primary); font-weight: bold; font-size: 1.2rem; }
        .old-price { text-decoration: line-through; color: #666; font-size: 0.9rem; margin-right: 5px; }
        .sale-badge { position: absolute; top: 10px; right: 10px; background: var(--sale); color: white; padding: 3px 8px; border-radius: 3px; font-weight: bold; font-size: 0.8rem; }
        
        .buy-btn { margin-top: auto; display: block; width: 100%; padding: 10px 0; background: linear-gradient(45deg, #005f99, #0088cc); color: white; text-decoration: none; border-radius: 5px; font-weight: bold; }
        
        .admin-controls { display: flex; gap: 5px; margin-top: 10px; }
        .edit-btn { background: #2196F3; color: white; border: none; padding: 5px; border-radius: 3px; cursor: pointer; flex: 1; }

        .list-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #333; font-size: 0.9rem; align-items: center;}
    </style>
</head>
<body>

    <div class="ticker-wrap"><div class="ticker" id="buyerTicker"></div></div>

    <nav>
        <div class="logo">StoreZ</div>
        <button class="admin-btn" id="authBtn" onclick="handleAuth()">Admin Login</button>
    </nav>

    <div class="container">
        <!-- ADMIN PANEL -->
        <div id="adminArea">
            
            <!-- DATA MANAGER (NEW) -->
            <div class="admin-section">
                <h4 class="admin-header">Data Manager (Backup/Restore)</h4>
                <p style="font-size:0.8rem; color:#aaa;">Use this to backup your cloud data or import items from the old version.</p>
                <button class="btn btn-io" onclick="exportFromFirebase()">â¬‡ Download Cloud Backup (JSON)</button>
                <button class="btn btn-io" onclick="document.getElementById('jsonInput').click()">â¬† Import JSON to Cloud</button>
                <input type="file" id="jsonInput" class="file-input" accept=".json" onchange="importToFirebase(this)">
            </div>

            <div class="admin-section">
                <h4 class="admin-header">Settings</h4>
                <div class="form-group">
                    <label>Global Buy Link</label>
                    <input type="text" id="globalLink" placeholder="https://m.me/Page">
                    <button class="btn btn-green" onclick="saveGlobalSettings()">Save Settings</button>
                </div>
            </div>

            <div class="admin-section">
                <h4 class="admin-header">Categories</h4>
                <div class="form-row">
                    <input type="text" id="catName" placeholder="Category Name" style="flex:1">
                    <button class="btn btn-save" style="width:auto; margin:0;" onclick="addCategory()">Add</button>
                </div>
                <div id="catList" style="margin-top:10px;"></div>
            </div>

            <div class="admin-section">
                <h4 class="admin-header">Add / Edit Item</h4>
                <input type="hidden" id="editItemId">
                <div class="form-row">
                    <div class="form-group"><label>Name</label><input type="text" id="itemName"></div>
                    <div class="form-group"><label>Category</label><select id="itemCatSelect"></select></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Price</label><input type="number" id="itemPrice"></div>
                    <div class="form-group"><label>Sale Price</label><input type="number" id="itemSale"></div>
                </div>
                <div class="form-group"><label>Image</label><input type="text" id="itemImg"></div>
                <div class="form-group"><label>Custom Link</label><input type="text" id="itemLink"></div>
                <button class="btn btn-save" onclick="saveItem()">Save Item</button>
                <button class="btn" style="background:#444; color:white;" onclick="clearForm()">Clear</button>
            </div>

            <div class="admin-section">
                <h4 class="admin-header">Add Fake Buyer</h4>
                <div class="form-row">
                    <input type="text" id="buyerName" placeholder="Name" style="flex:1">
                    <input type="text" id="buyerItem" placeholder="Item" style="flex:1">
                    <button class="btn btn-save" style="width:auto; margin:0;" onclick="addBuyer()">Add</button>
                </div>
                <div id="buyerList" style="margin-top:10px; max-height:100px; overflow-y:auto;"></div>
            </div>
        </div>

        <!-- PUBLIC STORE CONTROLS -->
        <div class="controls-row">
            <div class="cat-tabs" id="catTabs"></div>
            <select id="sortSelect" class="sort-select" onchange="renderStore()">
                <option value="default">Default Order</option>
                <option value="low">Price: Low to High</option>
                <option value="high">Price: High to Low</option>
                <option value="az">Name: A-Z</option>
            </select>
        </div>

        <div class="store-grid" id="storeGrid"></div>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, onSnapshot, doc, deleteDoc, updateDoc, setDoc, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // ------------------------------------------------------------------
        // PASTE YOUR FIREBASE CONFIG HERE
        // ------------------------------------------------------------------
const firebaseConfig = {
  apiKey: "AIzaSyDY5pFsMKK3o-_GzDdrhoqvKJiMGYQFdzo",
  authDomain: "storez-68603.firebaseapp.com",
  projectId: "storez-68603",
  storageBucket: "storez-68603.firebasestorage.app",
  messagingSenderId: "555550726462",
  appId: "1:555550726462:web:98cfd4a27cfdb04209346f"
};        // ------------------------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // State
        let itemsData = [];
        let categoriesData = [];
        let globalLink = "#";
        let currentCat = "All";
        let isAdmin = false;

        // --- AUTH ---
        window.handleAuth = () => {
            if (auth.currentUser) {
                signOut(auth).then(() => alert("Logged Out"));
            } else {
                const email = prompt("Email:");
                const pass = prompt("Password:");
                if(email && pass) signInWithEmailAndPassword(auth, email, pass).catch(e => alert(e.message));
            }
        };

        onAuthStateChanged(auth, (user) => {
            const btn = document.getElementById("authBtn");
            const panel = document.getElementById("adminArea");
            isAdmin = !!user;
            if (user) {
                btn.innerText = "Logout";
                btn.style.background = "var(--primary)";
                btn.style.color = "black";
                panel.style.display = "block";
            } else {
                btn.innerText = "Admin Login";
                btn.style.background = "transparent";
                btn.style.color = "var(--primary)";
                panel.style.display = "none";
            }
            renderStore();
        });

        // --- DATA SYNC ---
        
        onSnapshot(doc(db, "settings", "global"), (doc) => {
            if(doc.exists()) {
                globalLink = doc.data().link || "#";
                document.getElementById("globalLink").value = globalLink;
                renderStore();
            }
        });

        const qCat = query(collection(db, "categories"), orderBy("order", "asc"));
        onSnapshot(qCat, (snapshot) => {
            categoriesData = [];
            snapshot.forEach((doc) => categoriesData.push({ id: doc.id, ...doc.data() }));
            renderCategories();
            renderCatList();
        });

        const qItems = query(collection(db, "items"), orderBy("order", "asc"));
        onSnapshot(qItems, (snapshot) => {
            itemsData = [];
            snapshot.forEach((doc) => itemsData.push({ id: doc.id, ...doc.data() }));
            renderStore();
        });

        onSnapshot(query(collection(db, "buyers"), orderBy("createdAt", "desc")), (snapshot) => {
            const buyers = [];
            snapshot.forEach((doc) => buyers.push({ id: doc.id, ...doc.data() }));
            renderTicker(buyers);
            renderBuyerList(buyers);
        });

        // --- IMPORT / EXPORT FUNCTIONS ---

        window.exportFromFirebase = async () => {
            const data = {
                items: itemsData,
                categories: categoriesData,
                settings: { globalLink: globalLink }
            };
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = "StoreZ_Cloud_Backup.json";
            a.click();
        };

        window.importToFirebase = async (input) => {
            const file = input.files[0];
            if(!file) return;

            if(!confirm("This will upload items from the JSON to Firebase. It will not delete existing items, but might create duplicates. Continue?")) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    const batch = writeBatch(db);
                    let count = 0;

                    // Import Categories
                    if(json.categories) {
                        json.categories.forEach(cat => {
                            const ref = doc(collection(db, "categories"));
                            batch.set(ref, { name: cat.name, order: cat.order || 0 });
                            count++;
                        });
                    }

                    // Import Items
                    if(json.items) {
                        json.items.forEach(item => {
                            const ref = doc(collection(db, "items"));
                            batch.set(ref, {
                                name: item.name,
                                price: item.price,
                                salePrice: item.salePrice || "",
                                catId: item.catId, // NOTE: Old IDs might not match new Category IDs. You might need to edit items.
                                image: item.image || "",
                                link: item.link || item.buyLink || "",
                                order: item.order || 0
                            });
                            count++;
                        });
                    }

                    // Import Settings
                    if(json.settings && json.settings.globalLink) {
                        const ref = doc(db, "settings", "global");
                        batch.set(ref, { link: json.settings.globalLink });
                    }

                    await batch.commit();
                    alert(`Successfully imported ${count} documents!`);

                } catch(err) {
                    alert("Error parsing JSON or uploading: " + err.message);
                }
            };
            reader.readAsText(file);
        };

        // --- CORE FUNCTIONS ---

        window.saveGlobalSettings = async () => {
            await setDoc(doc(db, "settings", "global"), { link: document.getElementById("globalLink").value });
            alert("Saved!");
        };

        window.addCategory = async () => {
            const name = document.getElementById("catName").value;
            if(name) {
                const order = categoriesData.length > 0 ? categoriesData[categoriesData.length-1].order + 1 : 1;
                await addDoc(collection(db, "categories"), { name, order });
                document.getElementById("catName").value = "";
            }
        };

        window.moveCategory = async (index, direction) => {
            if((direction === -1 && index === 0) || (direction === 1 && index === categoriesData.length - 1)) return;
            const current = categoriesData[index];
            const neighbor = categoriesData[index + direction];
            await updateDoc(doc(db, "categories", current.id), { order: neighbor.order });
            await updateDoc(doc(db, "categories", neighbor.id), { order: current.order });
        };

        window.deleteCategory = async (id) => { if(confirm("Delete category?")) await deleteDoc(doc(db, "categories", id)); };

        function renderCategories() {
            const container = document.getElementById("catTabs");
            const select = document.getElementById("itemCatSelect");
            
            let tabs = `<div class="cat-tab ${currentCat === 'All' ? 'active' : ''}" onclick="window.setCat('All')">All</div>`;
            let opts = `<option value="">Select...</option>`;

            categoriesData.forEach(c => {
                tabs += `<div class="cat-tab ${currentCat === c.id ? 'active' : ''}" onclick="window.setCat('${c.id}')">${c.name}</div>`;
                opts += `<option value="${c.id}">${c.name}</option>`;
            });
            container.innerHTML = tabs;
            select.innerHTML = opts;
        }

        window.setCat = (id) => { currentCat = id; renderStore(); };

        function renderCatList() {
            const list = document.getElementById("catList");
            list.innerHTML = "";
            categoriesData.forEach((c, i) => {
                list.innerHTML += `
                    <div class="list-item">
                        <span>${c.name}</span> 
                        <div>
                            <button class="btn-move" onclick="moveCategory(${i}, -1)">â–²</button>
                            <button class="btn-move" onclick="moveCategory(${i}, 1)">â–¼</button>
                            <button class="btn-del" onclick="deleteCategory('${c.id}')">X</button>
                        </div>
                    </div>`;
            });
        }

        window.saveItem = async () => {
            const id = document.getElementById("editItemId").value;
            const data = {
                name: document.getElementById("itemName").value,
                price: Number(document.getElementById("itemPrice").value),
                salePrice: document.getElementById("itemSale").value,
                catId: document.getElementById("itemCatSelect").value,
                image: document.getElementById("itemImg").value,
                link: document.getElementById("itemLink").value
            };
            
            if(!data.name || !data.price || !data.catId) { alert("Missing info"); return; }

            if(id) {
                await updateDoc(doc(db, "items", id), data);
            } else {
                const order = itemsData.length > 0 ? Math.max(...itemsData.map(i=>i.order||0)) + 1 : 1;
                data.order = order;
                await addDoc(collection(db, "items"), data);
            }
            window.clearForm();
        };

        window.deleteItem = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, "items", id)); };
        
        window.editItem = (id) => {
            const item = itemsData.find(i => i.id === id);
            document.getElementById("editItemId").value = item.id;
            document.getElementById("itemName").value = item.name;
            document.getElementById("itemPrice").value = item.price;
            document.getElementById("itemSale").value = item.salePrice;
            document.getElementById("itemCatSelect").value = item.catId;
            document.getElementById("itemImg").value = item.image;
            document.getElementById("itemLink").value = item.link;
            document.getElementById("adminArea").scrollIntoView();
        };

        window.clearForm = () => {
            document.querySelectorAll("#adminArea input").forEach(i => i.value = "");
            document.getElementById("itemCatSelect").value = "";
        };

        let draggedId = null;
        window.dragStart = (e, id) => { draggedId = id; e.target.classList.add('dragging'); };
        window.dragOver = (e) => { e.preventDefault(); };
        window.drop = async (e, targetId) => {
            e.preventDefault();
            document.querySelector('.dragging')?.classList.remove('dragging');
            if(draggedId === targetId) return;

            const dragItem = itemsData.find(i => i.id === draggedId);
            const targetItem = itemsData.find(i => i.id === targetId);
            await updateDoc(doc(db, "items", draggedId), { order: targetItem.order || 0 });
            await updateDoc(doc(db, "items", targetId), { order: dragItem.order || 0 });
        };

        window.renderStore = () => {
            const grid = document.getElementById("storeGrid");
            const sortMode = document.getElementById("sortSelect").value;
            grid.innerHTML = "";
            
            let filtered = currentCat === "All" ? [...itemsData] : itemsData.filter(i => i.catId === currentCat);

            if(sortMode === 'low') filtered.sort((a,b) => (Number(a.salePrice)||a.price) - (Number(b.salePrice)||b.price));
            if(sortMode === 'high') filtered.sort((a,b) => (Number(b.salePrice)||b.price) - (Number(a.salePrice)||a.price));
            if(sortMode === 'az') filtered.sort((a,b) => a.name.localeCompare(b.name));

            filtered.forEach(item => {
                const onSale = item.salePrice && Number(item.salePrice) < item.price;
                let priceHtml = `<span class="current-price">â‚±${item.price}</span>`;
                let badge = "";
                if(onSale) {
                    priceHtml = `<span class="old-price">â‚±${item.price}</span><span class="current-price" style="color:red">â‚±${item.salePrice}</span>`;
                    badge = `<div class="sale-badge">SALE</div>`;
                }

                let finalLink = item.link || globalLink;
                if(!finalLink.startsWith("http")) finalLink = "https://" + finalLink;

                let adminHtml = "";
                let dragAttr = "";

                if(isAdmin) {
                    adminHtml = `<div class="admin-controls"><button class="edit-btn" onclick="editItem('${item.id}')">Edit</button><button class="btn-del" onclick="deleteItem('${item.id}')">Del</button></div>`;
                    if(sortMode === 'default') {
                        dragAttr = `draggable="true" ondragstart="dragStart(event, '${item.id}')" ondragover="dragOver(event)" ondrop="drop(event, '${item.id}')" class="card draggable"`;
                    } else {
                        dragAttr = `class="card"`;
                    }
                } else {
                    dragAttr = `class="card"`;
                }

                grid.innerHTML += `
                    <div ${dragAttr}>
                        ${badge}
                        <img src="${item.image || 'https://placehold.co/200x150?text=No+Image'}" class="card-img-top">
                        <div class="card-body">
                            <h3 class="card-title">${item.name}</h3>
                            <div class="price-container">${priceHtml}</div>
                            <a href="${finalLink}" target="_blank" class="buy-btn">Buy Now</a>
                            ${adminHtml}
                        </div>
                    </div>`;
            });
        };

        window.addBuyer = async () => {
            const name = document.getElementById("buyerName").value;
            const item = document.getElementById("buyerItem").value;
            if(name && item) {
                await addDoc(collection(db, "buyers"), { name, item, createdAt: Date.now() });
                document.getElementById("buyerName").value = "";
            }
        };
        window.deleteBuyer = async (id) => await deleteDoc(doc(db, "buyers", id));

        function renderTicker(buyers) {
            let html = "";
            buyers.slice(0, 15).forEach(b => html += `<div class="ticker-item">ðŸŽ‰ <b>${b.name}</b> bought <b>${b.item}</b></div>`);
            if(buyers.length > 0 && buyers.length < 5) html += html + html;
            document.getElementById("buyerTicker").innerHTML = html;
        }

        function renderBuyerList(buyers) {
            const list = document.getElementById("buyerList");
            list.innerHTML = "";
            buyers.forEach(b => {
                list.innerHTML += `<div class="list-item"><span>${b.name}</span> <button class="btn-del" onclick="deleteBuyer('${b.id}')">X</button></div>`;
            });
        }
    </script>
</body>
</html>
